<!DOCTYPE html>
<html lang="en">
<head>
	<include href="blocks/head.html" />
	<link rel="stylesheet" href="minify/css/jquery-ui-1.10.3.css" type="text/css" media="all">
	<link rel="stylesheet" href="minify/css/taskboard.css">
	<check if="{{ !empty(@taskboard[0]) }}">
		<style type="text/css">
		/* Ensure optimal column widths */
		#taskboard table {
			min-width: {{ 320 * count(@taskboard[0].columns) + 252 }}px;
			width: auto;
		}

		/* Show all columns when possible */
		@media screen and (min-width: {{ 490 * count(@taskboard[0].columns) + 252 }}px) {
			#taskboard table .column:not(.column-1) {
				width: 490px;
			}
		}
		</style>
	</check>
	<!--[if lte IE 9]>
		<style type="text/css">
			/*  Fix RGBA issues */
			#taskboard .card {
				color: #000000;
				background-color: #ffffff;
			}
		</style>
	<![endif]-->
</head>
<body>
	<include href="blocks/navbar.html" />
	<section id="taskboard">
		<table class="table taskboard-head">
			<tr class="tb-row">
				<th class="column column-1">
					<div class="btn-group">
						<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" data-target=".bs-example-modal-lg">
							<span class="glyphicon glyphicon-filter"></span> Filter Tasks <span class="caret"></span>
						</button>
						<ul class="dropdown-menu" role="menu">
							<li class="{{ @filter == 'all' ? 'active' : '' }}"><a href="taskboard/{{ @PARAMS.id }}/all">All Tasks</a></li>
							<li class="{{ @filter == 'groups' ? 'active' : '' }}"><a href="taskboard/{{ @PARAMS.id }}/groups">My Groups</a></li>
							<li class="{{ @filter == 'me' ? 'active' : '' }}"><a href="taskboard/{{ @PARAMS.id }}/me">My Tasks</a></li>
							<li class="divider"></li>
							<repeat group="{{ @groups }}" value="{{ @group }}">
								<li class="{{ @group.id == @filter ? 'active' : '' }}"><a href="taskboard/{{ @PARAMS.id }}/{{ @group.id }}">{{ @group.name }}</a></li>
							</repeat>
						</ul>
					</div>
					<button class="btn btn-default btn-xs dropdown-toggle" data-toggle="modal" data-target="#burndown-modal">
						<span class="glyphicon glyphicon-fire"></span> Burndown
					</button>
					<a href="taskboard/{{ @PARAMS.id }}/{{ @filter }}" class="btn btn-default btn-xs" title="Reload taskboard">
						<span class="glyphicon glyphicon-repeat"></span>
					</a>
				</th>
				<repeat group="{{ @statuses }}" key="{{ @key }}" value="{{ @value }}">
					<th class="column column-{{ @key + 2 }}">{{ @value.name }}</th>
				</repeat>
			</tr>
		</table>
		<table id="task-table" class="table">
			<repeat group="{{ @taskboard }}" value="{{ @row }}">
				<tr data-story-id="{{ @row.project.id }}" class="tb-row">
					<td class="column column-1">
						<div class="card story {{ @row.project.closed_date ? 'completed' : '' }}" style="border-color:#{{ @row.project.owner_task_color }};">
							<div class="top">
								<i title="Add Task" class="add-task pull-right"></i>
								<span class="owner">
									<a href="user/{{ @row.project.owner_username }}" target="_blank">{{ @row.project.owner_name }}</a>
								</span>
								<span class="task-id">
									<a href="issues/{{ @row.project.id }}" target="_blank">{{ @row.project.id }}</a>
								</span>

								<span class="task-dueDate">{{ empty(@row.project.due_date) ? "" : date('n/j', strtotime(@row.project.due_date)) }}</span>
							</div>
							<div class="title">{{ @row.project.name }}</div>
						</div>
					</td>
					<repeat group="{{ @row.columns }}" key="{{ @status_id }}" value="{{ @col }}" >
						<td class="column column-{{ @status_id + 1 }} {{ @statuses[@status_id]['closed'] ? 'completed' : '' }} droppable" data-status="{{ @status_id }}">
							<repeat group="{{ @col }}" value="{{ @task }}">
								<div class="card task well has-popover" id="task_{{ @task.id }}" data-id="{{ @task.id }}" data-html="true" data-trigger="hover" data-toggle="popover" data-placement="auto top" data-content="
								<p><strong>Author: </strong>{{ @task.author_name }}</p>
								<p><strong>Description: </strong> {{ strlen(@task.description) > 500 ? htmlentities(substr(@task.description, 0, 500)) . " [...]" : htmlentities(@task.description) }}</p>
								" style="border-color:#{{ @task.owner_task_color }};">
									<div class="hours">{{ @task.hours_remaining ? @task.hours_remaining : '' }}</div>
									<div class="top">
										<span class="task-id"><a href="issues/{{ @task.id }}" target="_blank">{{ @task.id }}</a></span>
										<span class="task-dueDate">{{ empty(@task.due_date) ? "" : date('n/j', strtotime(@task.due_date)) }}</span>
									</div>
									<div class="title">{{ @task.name }}</div>
									<div class="description">{{ htmlentities(@task.description) }}</div>
									<check if="{{ strtotime(@task.due_date) > 0 }}">
										<true>
											<div class="dueDate">{{ date('n/j/Y', strtotime(@task.due_date)) }}</div>
										</true>
										<false>
											<div class="dueDate"></div>
										</false>
									</check>
									<check if="{{ @task.priority == 0 }}">
										<true>
											<div class="priority normal" data-val="{{ @task.priority }}">{{ @task.priority_name }}</div>
										</true>
										<false>
											<check if="{{ @task.priority < 0 }}">
												<true>
													<div class="priority low" data-val="{{ @task.priority }}">{{ @task.priority_name }}</div>
												</true>
												<false>
													<div class="priority high" data-val="{{ @task.priority }}">{{ @task.priority_name }}</div>
												</false>
											</check>
										</false>
									</check>
									<div class="owner" data-id="{{ @task.owner_id }}">
										<a href="user/{{ @task.owner_username }}" target="_blank">{{ @task.owner_name }}</a>
									</div>
								</div>
							</repeat>
						</td>
					</repeat>
				</tr>
			</repeat>
		</table>
		<div id="task-dialog" class="dialog" title="Edit Task" style="display: none;">
			<div class="row">
				<form id="task-dialog">
					<fieldset>
						<input type="hidden" name="taskId" id="taskId" value="">
						<div class="col-md-7">
							<label for="title">Title</label>
							<input type="text" name="title" id="title" class="form-control" />
							<label for="Description">Description</label>
							<textarea name="description" id="description" class="form-control"  rows="6"></textarea>
						</div>
						<div class="col-md-5">
							<label for="assigned">Assigned To</label>
							<select id="assigned" name="assigned" class="form-control" onchange="Taskboard.changeUser(this)">
								<option value="0" data-color="#AAAAAA">Not Assigned</option>
								<option value="{{ @user.id }}" data-color="#{{ @user.task_color }}" selected>{{ @user.name }}</option>
								<optgroup label="Groups">
									<repeat group="{{ @groups }}" value="{{ @group }}">
										<option value="{{ @group.id }}" data-color="#{{ @group.task_color }}">{{ @group.name }}</option>
									</repeat>
								</optgroup>
								<optgroup label="Users">
									<repeat group="{{ @users }}" value="{{ @user }}">
										<option value="{{ @user.id }}" data-color="#{{ @user.task_color }}" data-username="{{ @user.username }}">{{ @user.name }}</option>
									</repeat>
								</optgroup>
							</select>
							<label for="hours">Remaining (Hours)</label>
							<input type="textbox" name="hours" id="hours" class="form-control">
							<label for="password">Due Date</label>
							<input type="textbox" name="dueDate" id="dueDate" value="" class="dueDate form-control">
							<label for="priority">Priority</label>
							<select id="priority" name="priority" class="form-control" onchange="Taskboard.changeModalPriority($(this).find('option:selected').val())">
								<repeat group="{{ @priorities }}" value="{{ @priority }}">
									<option value="{{ @priority.value }}">{{ @priority.name }}</option>
								</repeat>
							</select>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</section>
	<div data-departement="" class="card task cloneable" id="new_task">
		<div class="hours"></div><div class="top">
			<span class="task-id"></span>
		</div>
		<div class="title"></div>
		<div class="description"></div>
		<div class="dueDate"></div>
		<div class="priority normal">Normal Priority</div><div class="owner"></div>
	</div>
	<div class="container-fluid">
		<include href="blocks/footer.html" />
	</div>

	<div class="modal fade" id="burndown-modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" style="min-width:970px;width:80%;max-width:1000px;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="myModalLabel">Burndown Chart</h4>
				</div>
				<div class="modal-body">
					<div style="width:920px;margin:0 auto;">
						<canvas width="920" height="400" id="burndown"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="minify/js/jquery-ui-1.10.3.min.js,jquery.ui.touch-punch.min.js"></script>
	<script src="minify/js/taskboard.js"></script>
	<script src="js/chart.js"></script>
	<script>
		var BurndownData;
		$(document).ready(function() {
			$.ajax({
				url: "taskboard/{{ @PARAMS.id }}/burndown/{{ @tasks }}",
				success: function(data) {
					BurndownData = data;
					$.getScript("minify/js/burndown.js", function() {
						Burndown.init();
					});
				},
				dataType: "json"
			});
		});
	</script>
</body>
</html>
