<!DOCTYPE html>
<html lang="en">
<head>
	<include href="blocks/head.html" />
	<include href="blocks/taskboard-head.html" />
	<check if="{{ !empty(@taskboard[0]) }}">
		<style type="text/css">
		/* Ensure optimal column widths */
		#taskboard table {
			min-width: {{ 252 * (count(@taskboard[0].columns) + 1) }}px;
		}

		/* Make large screens more useful */
		@media screen and (min-width: {{ 350 * (count(@taskboard[0].columns) + 1) }}px) {
			#taskboard, #taskboard .card {
				font-size: 14px;
			}
			#taskboard .column:not(.column-1) {
				width: 350px;
			}
			#taskboard .card.story .top {
				height: 20px;
				padding: 0;
			}
			#taskboard .card.story .owner {
				width: 135px;
			}
			#taskboard .card.task {
				width: 160px;
				height: 120px;
			}
			#taskboard .card .top {
				height: 20px;
			}
			#taskboard .card .title {
				top: -4px;
				height: 78px;
			}
			#taskboard .card .owner {
				height: 18px;
			}
			#taskboard .card .hours,
			#taskboard .card .priority {
				padding: 0px 7px;
				line-height: 18px;
				font-size: 16px;
			}
		}
		</style>
	</check>
</head>
<body>
	<include href="blocks/navbar.html" />
	<section id="taskboard">
		<table class="table taskboard-head">
			<tr class="tb-row">
				<th class="column column-1">
					<div class="btn-group">
						<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
							Filter Tasks <span class="caret"></span>
						</button>
						<ul class="dropdown-menu" role="menu">
							<li class="{{ @filter == 'all' ? 'active' : '' }}"><a href="/taskboard/{{ @PARAMS.id }}/all">All Tasks</a></li>
							<li class="{{ @filter == 'groups' ? 'active' : '' }}"><a href="/taskboard/{{ @PARAMS.id }}/groups">My Groups</a></li>
							<li class="{{ @filter == 'me' ? 'active' : '' }}"><a href="/taskboard/{{ @PARAMS.id }}/me">My Tasks</a></li>
						</ul>
					</div>
				</th>
				<repeat group="{{ @statuses }}" key="{{ @key }}" value="{{ @value }}">
					<th class="column column-{{ @key + 2 }}">{{ @value.name }}</th>
				</repeat>
			</tr>
		</table>
		<table id="task-table" class="table">
			<repeat group="{{ @taskboard }}" value="{{ @row }}">
				<tr data-story-id="{{ @row.project.id }}" class="tb-row">
					<td class="column column-1">
						<div data-departement="I.T." class="card story" style="border-color:#{{ @row.project.owner_task_color }};">
							<div class="top">
								<i title="Add Task" class="add-task pull-right"></i>
								<span class="owner">
									<a href="/user/{{ @row.project.owner_username }}" target="_blank">{{ @row.project.owner_name }}</a>
								</span>
								<span class="task-id">
									<a href="/issues/{{ @row.project.id }}" target="_blank">{{ @row.project.id }}</a>
								</span>
								<span class="task-dueDate">{{ empty(@row.project.due_date) ? "" : date('n/j', strtotime(@row.project.due_date)) }}</span>
							</div>
							<div class="title">{{ @row.project.name }}</div>
						</div>
					</td>
					<repeat group="{{ @row.columns }}" key="{{ @status_id }}" value="{{ @col }}">
						<td class="column column-{{ @status_id + 1 }} {{ @statuses[@status_id]['closed'] ? 'completed' : '' }} droppable" data-status="{{ @status_id }}">
							<repeat group="{{ @col }}" value="{{ @task }}">
								<div data-departement="" class="card task" id="task_{{ @task.id }}" style="border-color:#{{ @task.owner_task_color }};">
									<div class="hours">{{ @task.hours_remaining ? @task.hours_remaining : '' }}</div>
									<div class="top">
										<span class="task-id"><a href="/issues/{{ @task.id }}" target="_blank">{{ @task.id }}</a></span>
										<span class="task-dueDate">{{ empty(@task.due_date) ? "" : date('n/j', strtotime(@task.due_date)) }}</span>
									</div>
									<div class="title">{{ @task.name }}</div>
									<div class="description">{{ @task.description }}</div>
									<check if="{{ strtotime(@task.due_date) > 0 }}">
										<true>
											<div class="dueDate">{{ date('n/j/Y', strtotime(@task.due_date)) }}</div>
										</true>
										<false>
											<div class="dueDate"></div>
										</false>
									</check>
									<check if="{{ @task.priority == 0 }}">
										<true>
											<div class="priority normal">{{ @task.priority_name }}</div>
										</true>
										<false>
											<check if="{{ @task.priority < 0 }}">
												<true>
													<div class="priority low">{{ @task.priority_name }}</div>
												</true>
												<false>
													<div class="priority high">{{ @task.priority_name }}</div>
												</false>
											</check>
										</false>
									</check>
									<div class="owner">
										<a href="/user/{{ @task.owner_username }}" target="_blank">{{ @task.owner_name }}</a>
									</div>
								</div>
							</repeat>
						</td>
					</repeat>
				</tr>
			</repeat>
		</table>
		<div id="task-dialog" class="dialog" title="Edit Task" style="display: none;">
			<div class="row">
				<form id="task-dialog">
					<fieldset>
						<input type="hidden" name="taskId" id="taskId" value="">
						<div class="col-md-7">
							<label for="title">Title</label>
							<input type="text" name="title" id="title" class="form-control" />
							<label for="Description">Description</label>
							<textarea name="description" id="description" class="form-control"  rows="6"></textarea>
						</div>
						<div class="col-md-5">
							<label for="assigned">Assigned To</label>
							<select id="assigned" name="assigned" class="form-control" onchange="Taskboard.changeUser(this)">
								<option value="0" data-color="#AAAAAA">Not Assigned</option>
								<option value="{{ @user.id }}" data-color="#{{ @user.task_color }}" selected>{{ @user.name }}</option>
								<optgroup label="Groups">
									<repeat group="{{ @groups }}" value="{{ @group }}">
										<option value="{{ @group.id }}" data-color="#{{ @group.task_color }}">{{ @group.name }}</option>
									</repeat>
								</optgroup>
								<optgroup label="Users">
									<repeat group="{{ @users }}" value="{{ @user }}">
										<option value="{{ @user.id }}" data-color="#{{ @user.task_color }}" data-username="{{ @user.username }}">{{ @user.name }}</option>
									</repeat>
								</optgroup>
							</select>
							<label for="hours">Remaining (Hours)</label>
							<input type="textbox" name="hours" id="hours" class="form-control">
							<label for="password">Due Date</label>
							<input type="textbox" name="dueDate" id="dueDate" value="" class="dueDate form-control">
							<label for="priority">Priority</label>
							<select id="priority" name="priority" class="form-control" onchange="Taskboard.changeModalPriority($(this).find('option:selected').val())">
								<repeat group="{{ @priorities }}" value="{{ @priority }}">
									<option value="{{ @priority.value }}">{{ @priority.name }}</option>
								</repeat>
							</select>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</section>
	<div data-departement="" class="card task cloneable" id="new_task">
		<div class="hours"></div><div class="top">
			<span class="task-id"></span>
		</div>
		<div class="title"></div>
		<div class="description"></div>
		<div class="dueDate"></div>
		<div class="priority normal">Normal Priority</div><div class="owner"></div>
	</div>
	<div class="container-fluid">
		<include href="blocks/footer.html" />
	</div>
	<canvas width="800" height="400" id="burndown"></canvas>

	<script src="/minify/js/jquery-ui-1.10.3.min.js,jquery.ui.touch-punch.min.js"></script>
	<script src="/minify/js/taskboard.js"></script>
	<script src="/js/chart.js"></script>
	<script>

		function oSize(obj) {
		    var size = 0, key;
		    for (key in obj) {
		        if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		}

		BurndownData = {{ @burndown |raw }};
		$(document).ready(function(){
			Burndown.init();
		});

		Burndown = {
			data :{
				labels: [],
				datasets: []
			},
			targetVelocity: {
				fillColor : "rgba(105,9,255,0.5)",
				strokeColor : "rgba(105,9,255,1)",
				pointColor : "#3d2a5b",
				pointStrokeColor : "#3d2a5b",
				data: []
			},
			actualVelocity: {
				fillColor : "rgba(220,220,220,0.0)",
				strokeColor : "rgba(255,132,0,1)",
				pointColor : "rgba(118,82,43,1)",
				pointStrokeColor : "rgba(118,82,43,1)",
				data: []
			},
			hoursDay: {
				fillColor : "rgba(60,185,145,0.5)",
				strokeColor : "rgba(60,185,145,1)",
				pointColor : "rgba(220,220,220,1)",
				pointStrokeColor : "#326a58",
				data: []
			},
			days: 0,
			initialHours: 0,
			canvasId: "burndown",
			rawData: BurndownData[0],
			init: function(){
				Burndown.createData();
				Burndown.data.datasets.push(Burndown.actualVelocity);
				Burndown.data.datasets.push(Burndown.targetVelocity);
				var ctx = document.getElementById(Burndown.canvasId).getContext("2d");
				var burndown = new Chart(ctx).Line(Burndown.data, Burndown.options);
			},
			createData: function(){

				//set burndown days
				Burndown.days = oSize(Burndown.rawData);
				var i = 0;
				sum = 0;

				//strip down to initial daty and set initial hours
				$.each(Burndown.rawData, function(key, val){
					if(i === 0){
						Burndown.initialHours = Burndown.sumHours(this);
					}
					else{
						return;
					}
					i++;
				});

				var target = Burndown.initialHours;
				var ratio = Burndown.initialHours / (Burndown.days -1);

				var i = Burndown.days;
				$.each(Burndown.rawData, function(key, val){
					//set  labels for each day
					Burndown.data.labels.push(key);

					//set actual velocity
					if(val){//check if it's null for actual velocity
						Burndown.actualVelocity.data.push(Burndown.sumHours(this));
					}

					//set target data
					Burndown.targetVelocity.data.push(target);
					target = target - ratio;


				});
			},
			sumHours: function(data){
				var sum = 0;
				$.each(data, function(key1, val1){
					sum = parseFloat(this.remaining) + sum;
				});
				return(sum);
			},
			options: {
				//Boolean - If we show the scale above the chart data
				scaleOverlay : false,

				//Boolean - If we want to override with a hard coded scale
				scaleOverride : false,

				//** Required if scaleOverride is true **
				//Number - The number of steps in a hard coded scale
				scaleSteps : null,
				//Number - The value jump in the hard coded scale
				scaleStepWidth : null,
				//Number - The scale starting value
				scaleStartValue : 0.0,

				//String - Colour of the scale line
				scaleLineColor : "rgba(0,0,0,.1)",

				//Number - Pixel width of the scale line
				scaleLineWidth : 1,

				//Boolean - Whether to show labels on the scale
				scaleShowLabels : true,

				//Interpolated JS string - can access value
				scaleLabel : "<%=value%>",

				//String - Scale label font declaration for the scale label
				scaleFontFamily : "'Arial'",

				//Number - Scale label font size in pixels
				scaleFontSize : 12,

				//String - Scale label font weight style
				scaleFontStyle : "normal",

				//String - Scale label font colour
				scaleFontColor : "#666",

				///Boolean - Whether grid lines are shown across the chart
				scaleShowGridLines : true,

				//String - Colour of the grid lines
				scaleGridLineColor : "rgba(0,0,0,.05)",

				//Number - Width of the grid lines
				scaleGridLineWidth : 1,

				//Boolean - Whether the line is curved between points
				bezierCurve : false,

				//Boolean - Whether to show a dot for each point
				pointDot : true,

				//Number - Radius of each point dot in pixels
				pointDotRadius : 2,

				//Number - Pixel width of point dot stroke
				pointDotStrokeWidth : 1,

				//Boolean - Whether to show a stroke for datasets
				datasetStroke : true,

				//Number - Pixel width of dataset stroke
				datasetStrokeWidth : 2,

				//Boolean - Whether to fill the dataset with a colour
				datasetFill : true,

				//Boolean - Whether to animate the chart
				animation : true,

				//Number - Number of animation steps
				animationSteps : 60,

				//String - Animation easing effect
				animationEasing : "easeOutQuart",

				//Function - Fires when the animation is complete
				onAnimationComplete : null
			}
		}



	</script>
</body>
</html>